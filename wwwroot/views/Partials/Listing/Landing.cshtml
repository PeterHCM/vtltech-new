@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Extensions
@inject Umbraco.Cms.Web.Common.UmbracoHelper Umbraco

@functions {
    List<string> GetCategories(IPublishedContent doc)
    {
        var val = doc.Value("category");
        return val switch
        {
            IEnumerable<string> list => list.Where(x => !string.IsNullOrWhiteSpace(x)).Select(x => x.Trim()).ToList(),
            string s => s.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                         .Select(x => x.Trim()).Where(x => x.Length > 0).ToList(),
            _ => new List<string>()
        };
    }
}

@{
    var currentPage = Umbraco.AssignedContentItem;
    var allDocuments = currentPage.DescendantsOrSelfOfType("documentation").ToList();
    var mainCats = new[] { "Company Profile", "Manufacturer", "Technical" };
    var download = Umbraco?.GetDictionaryValue("Download") ?? "Xem / Download";

    var categoryList = new List<string> { "All" };

    foreach (var cat in mainCats)
    {
        if (allDocuments.Any(doc =>
            GetCategories(doc).Any(c => string.Equals(c, cat, StringComparison.OrdinalIgnoreCase))))
        {
            categoryList.Add(cat);
        }
    }
    bool hasOther = allDocuments.Any(doc =>
    {
        var cats = GetCategories(doc);
        return cats.All(c => !mainCats.Contains(c, StringComparer.OrdinalIgnoreCase));
    });
    if (hasOther)
    {
        categoryList.Add("Other");
    }
}

<!-- Filter buttons -->
<div class="flex flex-wrap justify-center gap-3 mt-10 mb-12 px-6 py-8">
  @foreach (var cat in categoryList)
  {
      <button data-category="@cat"
          class="filter-btn px-5 py-2 rounded-md border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-white transition">
          @(
            !string.IsNullOrWhiteSpace(Umbraco?.GetDictionaryValue(cat))
                ? Umbraco.GetDictionaryValue(cat)
                : cat
          )
      </button>
  }
</div>
<!-- Document Grid -->
<div id="docGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 px-6 pb-16">
  @foreach (var item in allDocuments)
  {
      var title = item.Value<string>("title") ?? item.Name;
      var description = item.Value<string>("description");
      var manufacturer = item.Value<string>("manufacturer");
      var categories = GetCategories(item);
      var updateDate = item.UpdateDate.ToString("dd/MM/yyyy");
      var iconUrl = item.Value<IEnumerable<IPublishedContent>>("icon")?.FirstOrDefault()?.Url() ?? "/media/default/VTL_logo.svg";
      var fileUrl = item.Url();
      var categoryAttr = categories.Any() ? string.Join(",", categories) : "Other";

      <div class="doc-card card group flex flex-col justify-between p-6" data-categories="@categoryAttr">
        <div>
          <div class="flex items-center gap-3 mb-4">
            <div class="flex items-center justify-center w-20 h-20 overflow-hidden">
                <img src="@iconUrl" alt="@title" class="h-auto w-full object-contain" />
            </div>
            <div class="min-h-[48px] flex items-start">
              <h3 class="text-lg font-semibold leading-snug group-hover:text-primary transition-colors line-clamp-2" title="@title">
                @title
              </h3>
            </div>
          </div>

          @if (!string.IsNullOrWhiteSpace(description))
          {
              <p class="text-sm clamp-3-lines mb-3" title="@description">@description</p>
          }
          @if (!string.IsNullOrWhiteSpace(manufacturer))
          {
              <p class="text-sm mb-2"><strong>Manufacturer:</strong> @manufacturer</p>
          }

          <div class="flex flex-col gap-y-1.5 mt-2 text-xs text-gray-500 dark:text-gray-400">
            <div class="flex items-center gap-2">
              <svg class="h-5 w-5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10M7 11h10M7 15h10" />
              </svg>
              <span class="line-clamp-2 min-h-[1.25rem]">@string.Join(", ", categories)</span>
            </div>
            <div class="flex items-center gap-2"> 
              <svg class="h-4 w-5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span class="min-h-[1.25rem]">@updateDate</span>
            </div>
          </div>
        </div>

        <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4 flex justify-between items-center">
          @if (!string.IsNullOrWhiteSpace(fileUrl))
          {
            <a href="@fileUrl" download class="btn-outline text-primary gap-2" target="_blank" rel="noopener noreferrer">
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4" />
              </svg>
              @download
            </a>
          }
          else
          {
              <span class="text-sm text-gray-400 dark:text-gray-500 italic">No file</span>
          }
        </div>
      </div>
  }
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {  
  const filterButtons = document.querySelectorAll(".filter-btn");
  const docCards = document.querySelectorAll(".doc-card");
  const mainCategories = ["Company Profile", "Manufacturer", "Technical"];

  function filterDocs(category) {
    docCards.forEach(card => {
      const cardCategories = (card.dataset.categories || "").split(",").map(c => c.trim());
      const isOther = !cardCategories.some(c => mainCategories.includes(c));
      let show = false;

      if (category === "All") {
        show = true;
      } else if (category === "Other") {
        show = isOther;
      } else {
        show = cardCategories.includes(category);
      }

      card.style.display = show ? "block" : "none";
    });

    filterButtons.forEach(btn => {
      const isActive = btn.dataset.category === category;
      btn.classList.toggle("bg-primary", isActive);
      btn.classList.toggle("text-white", isActive);
    });
  }

  const initialCategory = decodeURIComponent(location.hash.replace("#", "")) || "All";
  filterDocs(initialCategory);

  filterButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const category = btn.dataset.category;
      location.hash = encodeURIComponent(category);
      filterDocs(category);
    });
  });

  window.addEventListener("hashchange", () => {
    const newCategory = decodeURIComponent(location.hash.replace("#", "")) || "All";
    filterDocs(newCategory);
  });
});
</script>