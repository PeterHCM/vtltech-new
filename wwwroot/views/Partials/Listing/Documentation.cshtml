@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Extensions
@inject Umbraco.Cms.Web.Common.UmbracoHelper Umbraco

@functions {
    // Hàm lấy danh sách Category an toàn
    List<string> GetCategories(IPublishedContent doc) {
        var val = doc?.Value("category");
        if (val == null) return new List<string>();
        
        if (val is IEnumerable<string> list) 
            return list.Where(x => !string.IsNullOrWhiteSpace(x)).ToList();
        
        return val.ToString().Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
                  .Select(x => x.Trim()).ToList();
    }
}

@{
    var allDocuments = Umbraco.AssignedContentItem?
        .DescendantsOfType("documentation")
        .ToList();

    // 4 mục chính bạn yêu cầu
    var mainCats = new List<string> { "All", "Company Profile", "Manufacturer", "Technical" };
    
    // Lấy các mục còn lại để cho vào dropdown
    var otherCats = allDocuments.SelectMany(GetCategories)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .Where(c => !mainCats.Contains(c, StringComparer.OrdinalIgnoreCase))
                    .OrderBy(c => c).ToList();
}

<section x-data="{ 
    activeCat: 'All',
    shouldShow(cardCatsStr) {
        if (this.activeCat === 'All') return true;
        let cardCats = cardCatsStr.split(',').map(s => s.trim().toLowerCase());
        return cardCats.includes(this.activeCat.toLowerCase());
    }
}" class="documentation">

    <div class="flex flex-wrap items-center gap-4 mt-12 mb-8 border-b border-slate-200 dark:border-white/10 pb-4">
        
        @* 4 Mục chính như cũ *@
        <div class="flex flex-wrap gap-2">
            @foreach (var cat in mainCats)
            {
                <button @@click="activeCat = '@cat'"
                        :class="activeCat === '@cat' ? 'bg-primary text-white' : 'bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-slate-400'"
                        class="px-5 py-2 text-xs font-bold uppercase tracking-widest transition-all hover:bg-primary hover:text-white">
                    @cat
                </button>
            }
        </div>

        @* Dropdown cho các Category khác *@
        @if (otherCats.Any())
        {
            <div class="relative" x-data="{ open: false }" @@click.away="open = false">
                <button @@click="open = !open" 
                        :class="!mainCats.includes(activeCat) && activeCat !== 'All' ? 'border-primary text-primary' : 'border-slate-300 dark:border-white/20 text-slate-500'"
                        class="px-5 py-2 text-xs font-bold uppercase tracking-widest border flex items-center gap-2 hover:border-primary transition-all">
                    <span x-text="!mainCats.includes(activeCat) ? activeCat : 'Other Categories'"></span>
                    <svg class="w-4 h-4 transition-transform" :class="open ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="2"/></svg>
                </button>

                <div x-show="open" x-transition 
                     class="absolute left-0 mt-2 w-56 bg-white dark:bg-[#121214] border border-slate-200 dark:border-white/10 shadow-2xl z-50 py-2">
                    @foreach (var cat in otherCats)
                    {
                        <button @@click="activeCat = '@cat'; open = false"
                                class="w-full text-left px-4 py-2 text-xs font-bold uppercase hover:bg-primary hover:text-white text-slate-600 dark:text-slate-400 transition-colors">
                            @cat
                        </button>
                    }
                </div>
            </div>
        }
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        @foreach (var item in allDocuments)
        {
            var title = item.Value<string>("title") ?? item.Name;
            var categories = GetCategories(item);
            var categoryAttr = string.Join(",", categories);
            var updateDate = item.UpdateDate.ToString("dd/MM/yyyy");
            var description = item.Value<string>("description");
            var fileUrl = item.Url();
            var iconUrl = item.Value<IEnumerable<IPublishedContent>>("icon")?.FirstOrDefault()?.Url() ?? "/media/default/pdf-icon.svg";

            <div x-show="shouldShow('@categoryAttr')" 
                 class="group bg-white dark:bg-[#0a0a0b] border border-slate-200 dark:border-white/5 p-6 flex flex-col justify-between transition-all hover:border-primary/50">
                
                <div>
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 border border-slate-200 dark:border-white/10 p-2 shrink-0">
                                <img src="@iconUrl" class="w-full h-full object-contain" />
                            </div>
                            <h3 class="text-sm font-black uppercase text-slate-900 dark:text-white group-hover:text-primary">@title</h3>
                        </div>
                        @* --- HIỂN THỊ NGÀY --- *@
                        <span class="text-[10px] font-mono text-slate-400">@updateDate</span>
                    </div>

                    @* --- HIỂN THỊ MÔ TẢ NGẮN --- *@
                    @if (!string.IsNullOrWhiteSpace(description))
                    {
                        <p class="text-[12px] text-slate-500 dark:text-slate-400 line-clamp-2 mb-4">@description</p>
                    }
                    
                    <div class="flex flex-wrap gap-1 mt-2">
                        @foreach(var c in categories) {
                            <span class="text-[9px] font-mono px-1.5 py-0.5 bg-slate-100 dark:bg-white/5 text-slate-400 uppercase">#@c</span>
                        }
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-dashed border-slate-200 dark:border-white/10 flex justify-between items-center">
                    <span class="text-[10px] font-mono text-slate-400">REF: @item.Id</span>
                    <a href="@fileUrl" target="_blank" class="flex items-center gap-2 text-[10px] font-black uppercase text-primary hover:underline">
                        Download
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4" stroke-width="2"/></svg>
                    </a>
                </div>
            </div>
        }
    </div>
</section>