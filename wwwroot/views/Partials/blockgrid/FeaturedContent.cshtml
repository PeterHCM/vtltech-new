@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockGridItem>
@using Umbraco.Extensions
@{
    var content = Model.Content;
    var title = content.Value<string>("title");
    var subTitle = content.Value<string>("subTitle");
    var description = content.Value<string>("description");
    var layout = content.Value<string>("layout")?.ToLowerInvariant() ?? "4";
    
    bool isCarousel = layout == "0";
    var items = content.Value<IEnumerable<IPublishedContent>>("links") ?? Enumerable.Empty<IPublishedContent>();
    
    // Hệ thống Grid linh hoạt - Phải dùng vtl-container để căn giữa
    var gridClass = layout switch {
        "1" => "grid-cols-1 gap-10",
        "3" => "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8",
        "4" => "grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6",
        "6" => "grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4",
        _   => "vtl-grid"
    };

    var carouselId = isCarousel ? $"vtl-carousel-{Guid.NewGuid():N}" : null;
}

<div class="vtl-block-adaptive col-span-12" id="@carouselId" style="grid-column: span @Model.ColumnSpan / span @Model.ColumnSpan;">
    
    @* 1. Header Section: Đồng bộ hóa Title & Subtitle *@
    @if (!string.IsNullOrWhiteSpace(title) || !string.IsNullOrWhiteSpace(subTitle))
    {
        <div class="max-w-4xl mx-auto text-center mb-16 px-4">
            @if (!string.IsNullOrWhiteSpace(subTitle)) { 
                <span class="vtl-section-subtitle">@subTitle</span> 
            }
            @if (!string.IsNullOrWhiteSpace(title)) { 
                <h2 class="vtl-section-title">@title</h2> 
                <div class="vtl-section-divider"></div> 
            }
            @if (!string.IsNullOrWhiteSpace(description)) { 
                <p class="text-gray-600 dark:text-gray-400 -mt-8">@description</p> 
            }
        </div>
    }

    @if (items.Any())
    {
        @* 2. Container chính: Chống tràn và định vị nút điều hướng *@
        <div class="relative @(isCarousel ? "px-4 md:px-14" : "")">
            
            <div class="@(isCarousel ? "overflow-hidden" : $"grid {gridClass}")">
                <div class="@(isCarousel ? "carousel-track" : "contents")">
                    
                    @foreach (var item in items)
                    {
                        var itemTitle = item.Value<string>("title") ?? item.Name;
                        var itemDesc = item.Value<string>("description");
                        var imgMedia = item.Value<IPublishedContent>("image") ?? item.Value<IEnumerable<IPublishedContent>>("image")?.FirstOrDefault();
                        var iconMedia = item.Value<IPublishedContent>("icon") ?? item.Value<IEnumerable<IPublishedContent>>("icon")?.FirstOrDefault();
                        
                        var imageUrl = imgMedia != null ? imgMedia.GetCropUrl(600, 400) : "/media/default/VTL_logo.svg";
                        var iconUrl = iconMedia?.Url() ?? "/media/default/VTL_logo.svg";
                        
                        <div class="@(isCarousel ? "carousel-slide" : "h-full")">
                            @* Thẻ Link bao toàn bộ, dùng group để kích hoạt hiệu ứng hover cho các con *@
                            <a href="@item.Url()" class="group block h-full">
                                <div class="vtl-card h-full flex flex-col overflow-hidden">
                                    
                                    @* Media: Phải có 'relative' để logo bám đúng vị trí *@
                                    <div class="vtl-media-ratio relative shrink-0 overflow-hidden">
                                        <img src="@imageUrl" alt="@itemTitle" class="vtl-img-zoom w-full h-full object-cover" loading="lazy" />
                                        
                                        @* Logo nổi trên ảnh (Chỉ hiện nếu không phải layout 6) *@
                                        @if (layout != "6") {
                                            <div class="absolute top-4 left-4 z-20">
                                                <div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-md p-1.5 rounded-xl shadow-lg border border-white/20">
                                                    <img src="@iconUrl" class="w-7 h-7 md:w-9 md:h-9 object-contain block" alt="icon" />
                                                </div>
                                            </div>
                                        }
                                        
                                        @* Overlay mờ khi hover *@
                                        <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                    </div>

                                    @* Nội dung văn bản *@
                                    <div class="p-6 md:p-8 flex flex-col flex-grow bg-white dark:bg-transparent">
                                        <h3 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white group-hover:text-primary transition-colors mb-3 line-clamp-2">
                                            @itemTitle
                                        </h3>
                                        
                                        @* Flex-grow đẩy Footer xuống đáy *@
                                        <div class="flex-grow">
                                            <p class="text-sm md:text-base text-gray-600 dark:text-gray-400 line-clamp-3 leading-relaxed">
                                                @itemDesc
                                            </p>
                                        </div>

                                        @* Footer của Card *@
                                        @if (layout != "6") {
                                            <div class="mt-6 pt-4 border-t border-gray-100 dark:border-white/5 flex items-center justify-between">
                                                <span class="vtl-link font-bold text-xs uppercase tracking-widest">Chi tiết</span>
                                                <svg class="w-5 h-5 text-primary transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                                </svg>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            </div>

            @* 3. Điều hướng Carousel *@
            @if (isCarousel)
            {
                <button class="carousel-prev absolute left-0 top-1/2 -translate-y-1/2 z-30 w-11 h-11 flex items-center justify-center rounded-full bg-white dark:bg-gray-800 shadow-xl border border-gray-100 dark:border-white/10 opacity-0 group-hover/carousel:opacity-100 transition-all hover:bg-primary hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="carousel-next absolute right-0 top-1/2 -translate-y-1/2 z-30 w-11 h-11 flex items-center justify-center rounded-full bg-white dark:bg-gray-800 shadow-xl border border-gray-100 dark:border-white/10 opacity-0 group-hover/carousel:opacity-100 transition-all hover:bg-primary hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            }
        </div>
    }
</div>

@* JS Logic cho Carousel *@
@if (isCarousel)
{
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const root = document.getElementById("@carouselId");
            const track = root.querySelector(".carousel-track");
            const slides = root.querySelectorAll(".carousel-slide");
            const next = root.querySelector(".carousel-next");
            const prev = root.querySelector(".carousel-prev");
            let index = 0;

            const update = () => {
                const spv = window.innerWidth < 640 ? 1 : (window.innerWidth < 1024 ? 2 : 4);
                const max = Math.max(0, slides.length - spv);
                index = Math.max(0, Math.min(index, max));
                
                const slideWidth = slides[0].offsetWidth;
                const gap = 32; // gap-8 = 32px
                track.style.transform = `translateX(-${index * (slideWidth + gap)}px)`;
                
                prev.style.opacity = index === 0 ? "0" : "1";
                prev.style.pointerEvents = index === 0 ? "none" : "auto";
                next.style.opacity = index === max ? "0" : "1";
                next.style.pointerEvents = index === max ? "none" : "auto";
            };

            next.onclick = (e) => { e.preventDefault(); index++; update(); };
            prev.onclick = (e) => { e.preventDefault(); index--; update(); };
            window.addEventListener("resize", update);
            update();
        });
    </script>
}