@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockGridItem>
@using Umbraco.Extensions
@{
    var content = Model.Content;
    var title = content.Value<string>("title");
    var subTitle = content.Value<string>("subTitle");
    var description = content.Value<string>("description");
    var layout = content.Value<string>("layout")?.ToLowerInvariant() ?? "4";
    
    // Gom nhóm logic hiển thị
    bool isCarousel = layout == "0";
    var items = content.Value<IEnumerable<IPublishedContent>>("links") ?? Enumerable.Empty<IPublishedContent>();
    var hideClass = layout == "6" ? "hidden" : "";
    var textClass = layout == "6" ? "text-xs sm:text-sm" : "";
    var titleClass = layout == "6" ? "text-sm sm:text-base" : "text-base sm:text-lg";
    // Class động
    var blockClass = $"col-span-12 row-span-12 sm:col-span-{Model.ColumnSpan} sm:row-span-{Model.RowSpan}";
    var gridClass = layout switch {
        "1" => "grid-cols-1 gap-8",
        "3" => "grid-cols-3 gap-4",
        "4" => "grid-cols-4 gap-4",
        "6" => "grid-cols-6 gap-2",
        _ => "grid-cols-4 gap-4"
    };

    var carouselId = isCarousel ? $"carousel-{Guid.NewGuid():N}" : null;
}
<div class="@blockClass @(isCarousel ? "carousel-root" : "")" id="@carouselId">
    <div class="block-wrapper">
        @if (!string.IsNullOrWhiteSpace(title) || !string.IsNullOrWhiteSpace(subTitle) || !string.IsNullOrWhiteSpace(description))
        {
            <div class="block-header mb-6 text-center">
                @if (!string.IsNullOrWhiteSpace(title)) { <h2 class="font-bold text-2xl">@title</h2> }
                @if (!string.IsNullOrWhiteSpace(subTitle)) { <h4 class="text-secondary opacity-75">@subTitle</h4> }
                @if (!string.IsNullOrWhiteSpace(description)) { <p class="mt-2">@description</p> }
            </div>
        }

        @if (items.Any())
        {
            <div class="@(isCarousel ? "carousel-container relative overflow-hidden" : "")">
                <div class="@(isCarousel ? "carousel-viewport overflow-hidden" : $"grid {gridClass} py-4")">
                    <div class="@(isCarousel ? "carousel-track flex transition-transform duration-500 ease-out" : "contents")"
                        style="@(isCarousel ? "display:flex; gap:16px; will-change:transform; transition:transform 0.5s ease;" : "")">
                        
                        @foreach (var item in items)
                        {
                            var itemTitle = item.Name;
                            var itemDesc = item.Value<string>("description");
                            var img = item.Value<IEnumerable<IPublishedContent>>("image")?.FirstOrDefault();
                            var icon = item.Value<IEnumerable<IPublishedContent>>("icon")?.FirstOrDefault();
                            
                            var imageUrl = img?.Url() ?? "/media/default/VTL_logo.svg";
                            if (img != null && !imageUrl.EndsWith(".svg")) imageUrl += "?width=400&format=webp";
                            
                            var iconUrl = icon?.Url() ?? "/media/default/VTL_logo.svg";
                            <div class="@(isCarousel ? "carousel-slide" : "card group")" 
                                 style="@(isCarousel ? "flex:0 0 calc((100% - 3*16px)/4);" : "")">
                                <a href="@item.Url()" class="card block h-full border rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
                                    <div class="relative aspect-video overflow-hidden bg-gray-100">
                                        <img src="@imageUrl" alt="@itemTitle" class="card-image" loading="lazy" />
                                    </div>
                                    <div class="p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            @if (layout != "6") { <img src="@iconUrl" class="w-5 h-5 object-contain" alt="icon" /> }
                                            <h3 class="font-semibold line-clamp-2 @titleClass">@itemTitle</h3>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(itemDesc)) {
                                            <p class="text-sm line-clamp-3 opacity-80" title="@itemDesc">@itemDesc</p>
                                        }
                                    </div>
                                </a>
                            </div>
                        }
                    </div>
                </div>

                @if (isCarousel)
                {
                    <button class="carousel-prev absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow hover:bg-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                    <button class="carousel-next absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow hover:bg-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                }
            </div>
        }
    </div>
</div>
@if (isCarousel)
{
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const root = document.getElementById("@carouselId");
            const track = root.querySelector(".carousel-track");
            const slides = root.querySelectorAll(".carousel-slide");
            const next = root.querySelector(".carousel-next");
            const prev = root.querySelector(".carousel-prev");
            let index = 0;

            const update = () => {
                const spv = window.innerWidth < 640 ? 1 : (window.innerWidth < 1024 ? 2 : 4);
                const max = Math.max(0, slides.length - spv);
                index = Math.max(0, Math.min(index, max));
                
                // Tính toán chính xác khoảng cách trượt
                const gap = 16; 
                const slideWidth = slides[0].offsetWidth;
                track.style.transform = `translateX(-${index * (slideWidth + gap)}px)`;
                
                prev.style.display = index === 0 ? "none" : "block";
                next.style.display = index === max ? "none" : "block";
            };

            next.onclick = () => { index++; update(); };
            prev.onclick = () => { index--; update(); };
            window.addEventListener("resize", update);
            update();
        });
    </script>
}
