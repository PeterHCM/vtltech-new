@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockGridItem>
@using Umbraco.Extensions
@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.PublishedContent
@using System.Linq
@using System.Collections.Generic

@{
    var content = Model.Content;
    var images = content.Value<IEnumerable<IPublishedContent>>("images")?.ToList() ?? new List<IPublishedContent>();
    var title = content.Value<string>("title");
    var description = content.Value<string>("description");
    var layout = content.Value<string>("layout")?.ToLowerInvariant() ?? "single";
    var links = content.Value<IEnumerable<Link>>("link")?.ToList() ?? new List<Link>();
    var link = links.FirstOrDefault();
    
    // Thuộc tính BlockGrid
    var columnSpan = ((int?)Model.ColumnSpan).GetValueOrDefault(12);
    var rowSpan = ((int?)Model.RowSpan).GetValueOrDefault(1);
    var blockClass = $"col-span-12 row-span-12 sm:col-span-{columnSpan} sm:row-span-{rowSpan}";
    
    // Key ngắn để định danh duy nhất (Chống xung đột JS)
    var keyShort = content.Key.ToString("N").Substring(0, 8);
    var image = images.FirstOrDefault();
}
<div class="@blockClass">
    <div class="vtl-container">
        @if (!string.IsNullOrWhiteSpace(title) || !string.IsNullOrWhiteSpace(description))
        {
            <div class="block-header mb-4">
                @if (!string.IsNullOrWhiteSpace(title)) { <h2 class="text-xl font-semibold">@title</h2> }
                @if (!string.IsNullOrWhiteSpace(description)) { <p class="text-gray-600 dark:text-gray-300">@description</p> }
            </div>
        }

        @RenderLayout(layout, images, keyShort)
    </div>
</div>

@functions {
    IHtmlContent RenderLayout(string layout, IEnumerable<IPublishedContent> images, string keyShort)
    {
        var partialName = layout switch
        {
            "single" => "ImageSingle",
            "carousel" => "ImageCarousel",
            "grid" => "ImageGrid",
            "thumbnail-gallery" => "ImageThumbnail",
            "masonry" => "ImageMasonry",
            _ => null
        };

        return partialName != null
            ? Html.PartialAsync($"Partials/Shared/{partialName}", images, new ViewDataDictionary(ViewData) { { "KeyShort", keyShort } }).Result
            : new HtmlString($"<p class='text-red-400 opacity-50'>Layout <strong>{layout}</strong> chưa có</p>");
    }
}