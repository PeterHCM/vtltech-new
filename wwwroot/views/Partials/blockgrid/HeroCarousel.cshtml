@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockGridItem>
@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Cms.Core.Models
@using Umbraco.Extensions

@{
    var content = Model?.Content;
    if (content == null) return;

    var banners = content.Value<BlockListModel>("banners");
    if (banners == null || !banners.Any()) return;

    // Tạo ID duy nhất để không bao giờ xung đột JS
    var bannerKey = "hero_" + content.Key.ToString("N").Substring(0, 8);
}

<section class="relative w-full overflow-hidden bg-[#0a0a0b] vtl-hero-section">
    <div id="@bannerKey" 
         class="relative group hero-carousel-root" 
         data-total-slides="@banners.Count()">
        
        @* Đổi tên class thành hero-track để tách biệt hoàn toàn *@
        <div class="hero-track flex transition-transform duration-[1000ms] ease-[cubic-bezier(0.4,0,0.2,1)]">
            @foreach (var banner in banners)
            {
                var b = banner.Content;
                if (b == null) continue;

                var heading = b.Value<string>("heading") ?? "";
                var subtitle = b.Value<string>("subtitle") ?? "";
                var ctaLinks = b.Value<IEnumerable<Link>>("ctaLinks") ?? Enumerable.Empty<Link>();
                var image = b.Value<IPublishedContent>("images") ?? b.Value<IEnumerable<IPublishedContent>>("images")?.FirstOrDefault();
                var icon = b.Value<IPublishedContent>("icons") ?? b.Value<IEnumerable<IPublishedContent>>("icons")?.FirstOrDefault();
                var isFirst = banner == banners.First();

                <div class="hero-slide w-full flex-shrink-0 relative h-[550px] md:h-[700px] lg:h-[850px] bg-black overflow-hidden">
                    @if (image != null)
                    {
                        <div class="absolute inset-0 z-0">
                            <img src="@(image.Url())?width=1920&quality=85&format=webp" 
                                 alt="@heading"
                                 class="hero-img w-full h-full object-cover transition-transform duration-[8000ms] ease-out scale-100" 
                                 loading="@(isFirst ? "eager" : "lazy")" />
                            @* Overlay đa tầng giúp text nổi bật hơn *@
                            <div class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/20 to-transparent"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0b] via-transparent to-transparent"></div>
                        </div>
                    }

                    <div class="vtl-container relative z-10 h-full flex items-center">
                        <div class="max-w-3xl px-4 text-left"> @* Đổi về căn trái cho chuyên nghiệp giống website Tech *@
                            @if (icon != null)
                            {
                                <img src="@icon.Url()" class="h-12 md:h-16 mb-8 object-contain animate-fade-in" alt="icon" />
                            }
                            
                            @if (!string.IsNullOrEmpty(heading))
                            {
                                <h2 class="text-4xl md:text-7xl font-bold text-white mb-6 leading-[1.1] tracking-tight">@heading</h2>
                            }
                            
                            @if (!string.IsNullOrEmpty(subtitle))
                            {
                                <p class="text-lg md:text-2xl text-gray-300 mb-12 max-w-2xl leading-relaxed">@subtitle</p>
                            }

                            @if (ctaLinks.Any())
                            {
                                <div class="flex flex-wrap gap-5">
                                    @foreach (var link in ctaLinks)
                                    {
                                        var isFirstBtn = link == ctaLinks.First();
                                        <a href="@link.Url" target="@link.Target" 
                                           class="vtl-btn @(isFirstBtn ? "vtl-btn-primary scale-110" : "bg-white/10 backdrop-blur-md text-white border border-white/20 hover:bg-white/20") py-4 px-8 text-base">
                                            @link.Name
                                        </a>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        @* Navigation Buttons: Chỉ hiện khi hover *@
        <button data-action="prev" class="absolute left-6 top-1/2 -translate-y-1/2 z-30 p-4 rounded-full bg-white/5 hover:bg-primary text-white opacity-0 group-hover:opacity-100 transition-all backdrop-blur-lg border border-white/10 shadow-2xl">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button data-action="next" class="absolute right-6 top-1/2 -translate-y-1/2 z-30 p-4 rounded-full bg-white/5 hover:bg-primary text-white opacity-0 group-hover:opacity-100 transition-all backdrop-blur-lg border border-white/10 shadow-2xl">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        @* Dots Progress Bar *@
        <div class="absolute bottom-12 left-1/2 -translate-x-1/2 z-30 flex gap-4">
            @for (int i = 0; i < banners.Count(); i++)
            {
                <button data-go-to="@i" class="hero-dot w-12 h-1 rounded-full bg-white/20 overflow-hidden transition-all duration-300">
                    <div class="hero-progress h-full bg-primary w-0"></div>
                </button>
            }
        </div>
    </div>
</section>

<style>
    /* Style riêng cho Hero để không dính tới component khác */
    .hero-track { display: flex; width: 100%; }
    .hero-dot.is-active { background-color: rgba(255,255,255,0.4); }
    .hero-dot.is-active .hero-progress { 
        width: 100%; 
        transition: width 6s linear; 
    }
    .hero-slide.is-active .hero-img {
        transform: scale(1.15); /* Hiệu ứng Ken Burns zoom nhẹ cực sang */
    }
</style>

<script>
    (function() {
        const id = '@bannerKey';
        const root = document.getElementById(id);
        if (!root) return;

        const track = root.querySelector('.hero-track');
        const slides = root.querySelectorAll('.hero-slide');
        const dots = root.querySelectorAll('.hero-dot');
        const total = parseInt(root.dataset.totalSlides);
        let current = 0;
        let timer;

        function update(index) {
            current = (index + total) % total;
            track.style.transform = `translateX(-${current * 100}%)`;
            
            dots.forEach((dot, i) => {
                dot.classList.toggle('is-active', i === current);
                const progress = dot.querySelector('.hero-progress');
                if (progress) progress.style.width = i === current ? '100%' : '0';
            });

            slides.forEach((slide, i) => {
                slide.classList.toggle('is-active', i === current);
            });
        }

        function startTimer() {
            clearInterval(timer);
            // Reset progress bar ngay lập tức trước khi chạy timer mới
            const activeProgress = dots[current].querySelector('.hero-progress');
            if(activeProgress) {
                activeProgress.style.transition = 'none';
                activeProgress.style.width = '0';
                setTimeout(() => {
                    activeProgress.style.transition = 'width 6s linear';
                    activeProgress.style.width = '100%';
                }, 10);
            }
            timer = setInterval(() => update(current + 1), 6000);
        }

        root.querySelector('[data-action="prev"]').onclick = () => { update(current - 1); startTimer(); };
        root.querySelector('[data-action="next"]').onclick = () => { update(current + 1); startTimer(); };
        
        dots.forEach((dot, i) => {
            dot.onclick = () => { update(i); startTimer(); };
        });

        // Khởi tạo
        update(0);
        startTimer();
    })();
</script>