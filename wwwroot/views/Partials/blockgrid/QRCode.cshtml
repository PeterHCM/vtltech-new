@inherits UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockGridItem>
@using Umbraco.Extensions
@using Umbraco.Cms.Core.Models

@{
    var content = Model.Content;
    var columnSpan = ((int?)Model.ColumnSpan).GetValueOrDefault(12);
    var rowSpan = ((int?)Model.RowSpan).GetValueOrDefault(1);
    
    // Responsive: Trên Mobile luôn là 12, trên Desktop lấy theo thiết kế
    var blockClass = $"col-span-12 md:col-span-{columnSpan} md:row-span-{rowSpan}";
    
    var title = content.Value<string>("title");
    var description = (content.Value<string>("description") ?? "").Replace("\n", "<br />");
    var link = content.Value<IEnumerable<Link>>("links")?.FirstOrDefault();
    
    var linkUrl = link?.Url;    
    var linkTarget = link?.Target ?? "_self";
    var domain = $"{Context.Request.Scheme}://{Context.Request.Host.Value}";
    
    // Xử lý URL đầy đủ để QR Code luôn hoạt động
    var fullUrl = !string.IsNullOrWhiteSpace(linkUrl) && !linkUrl.StartsWith("http", StringComparison.OrdinalIgnoreCase)
        ? $"{domain}{linkUrl}"
        : linkUrl;        
        
    // Tạo QR Code với màu thương hiệu (Xanh mòng két #006361 cho chuyên nghiệp)
    var qrUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={Uri.EscapeDataString(fullUrl ?? domain)}&color=006361";
}

<div class="@blockClass group">
    <div class="h-full p-6 md:p-8 bg-white dark:bg-gray-900/50 rounded-[2rem] border border-gray-100 dark:border-white/5 shadow-sm hover:shadow-xl hover:border-[#e06800]/20 transition-all duration-500 flex flex-col">
        
        <div class="flex-1">
            @if (!string.IsNullOrWhiteSpace(title))
            {
                <h3 class="text-xl md:text-2xl font-black text-gray-900 dark:text-white uppercase tracking-tighter mb-4 group-hover:text-[#e06800] transition-colors">
                    @title<span class="text-[#e06800]">.</span>
                </h3>
            }

            @if (!string.IsNullOrWhiteSpace(description))
            {
                <div class="text-sm md:text-base text-gray-500 dark:text-gray-400 leading-relaxed mb-6">
                    @Html.Raw(description)
                </div>
            }
        </div>

        @if (!string.IsNullOrWhiteSpace(linkUrl))
        {
            <div class="mt-auto pt-6 flex flex-col sm:flex-row items-center gap-6 border-t border-gray-50 dark:border-white/5">
                @* QR Code với khung thiết kế riêng *@
                <a href="@linkUrl" target="@linkTarget" class="relative p-2 bg-white rounded-2xl shadow-inner border border-gray-100 shrink-0 transition-transform hover:scale-105">
                    <img src="@qrUrl" alt="Scan to visit" class="h-20 w-20" loading="lazy" />
                    <div class="absolute inset-0 border-2 border-transparent hover:border-[#006361]/20 rounded-2xl transition-all"></div>
                </a>

                @* Nút bấm hành động *@
                <div class="flex flex-col items-center sm:items-start">
                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-[#006361] mb-2">Truy cập nhanh</span>
                    <a href="@linkUrl" target="@linkTarget" class="inline-flex items-center gap-2 text-[#e06800] font-bold text-sm hover:underline">
                        @(link?.Name ?? "Xem chi tiết")
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                    </a>
                </div>
            </div>
        }
    </div>
</div>