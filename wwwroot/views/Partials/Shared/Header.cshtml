@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<IPublishedContent>
@using Umbraco.Extensions
@inject IPublishedValueFallback PublishedValueFallback

@{
    // 1. SETTINGS & LOGO
    var settings = Umbraco.ContentAtRoot()?.FirstOrDefault(x => x.ContentType.Alias == "companySettings");
    var logoLight = settings?.Value<IEnumerable<IPublishedContent>>("websiteLogo")?.FirstOrDefault();
    var logoDark = settings?.Value<IEnumerable<IPublishedContent>>("websiteLogoDark")?.FirstOrDefault();
    var companyName = settings?.Value<string>("companyName") ?? "VTL TECH";

    var menuItems = Model.Root().Children()
        .Where(x => x.IsVisible(PublishedValueFallback) && !x.Value<bool>("naviHide"))
        .ToArray();

    // 2. AUTH & LINKS
    var isIntranet = Context.Request.Host.Value.Contains("intranet");
    var isLoggedIn = Context.User?.Identity?.IsAuthenticated ?? false;
    var memberName = Context.User?.Identity?.Name ?? "User";

    var sGuid = isIntranet ? "8d9393a2-028a-4b82-ba66-91aa42f2f753" : "c0e6b387-4aea-4dde-a1ad-14e94775fe1d";
    var searchUrl = Umbraco.Content(new Guid(sGuid))?.Url() ?? "/search";
    var loginUrl = Umbraco.Content(new Guid("00af5c49-5550-46f9-b528-e981426a70f6"))?.Url() ?? "/login";
}

<style>
    [x-cloak] { display: none !important; }
    /* Menu cấp 3 hiển thị bên cạnh cấp 2 */
    .submenu-pc { left: 100%; top: 0; margin-left: 1px; }
</style>

<header x-data="{ mobileOpen: false, searchOpen: false }" class="relative w-full bg-white dark:bg-[#0a0a0b] border-b dark:border-white/5 z-[100]">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-[75px]">
        
        <div class="flex items-center shrink-0">
            <a href="/" class="inline-block py-2">
                @if (logoLight != null) { <img src="@logoLight.Url()" class="h-10 w-auto dark:hidden" alt="Logo" /> }
                @if (logoDark != null) { <img src="@logoDark.Url()" class="hidden dark:block h-10 w-auto" alt="Logo" /> }
                @if (logoLight == null && logoDark == null) { <span class="text-xl font-bold text-primary">@companyName</span> }
            </a>
        </div>

        <nav class="hidden md:flex items-center flex-grow ml-10 h-full">
            <ul class="flex items-center gap-1 h-full">
                @foreach (var item in menuItems) {
                    var l2Items = item.Children().Where(x => x.IsVisible(PublishedValueFallback)).ToArray();
                    <li class="relative h-full flex items-center" x-data="{ open: false }" @@mouseenter="open = true" @@mouseleave="open = false">
                        <a href="@item.Url()" class="px-4 h-full flex items-center gap-1 text-sm font-semibold @(item.IsAncestorOrSelf(Model) ? "text-primary border-b-2 border-primary" : "text-gray-700 dark:text-gray-300 hover:text-primary")">
                            @item.Name
                        </a>
                        @if (l2Items.Any()) {
                            <ul x-show="open" x-cloak class="absolute top-full left-0 w-64 py-2 bg-white dark:bg-[#141416] shadow-2xl border border-gray-100 dark:border-white/10 rounded-b-xl">
                                @foreach (var child in l2Items) {
                                    var l3Items = child.Children().Where(x => x.IsVisible(PublishedValueFallback)).ToArray();
                                    <li class="relative" x-data="{ subOpen: false }" @@mouseenter="subOpen = true" @@mouseleave="subOpen = false">
                                        <a href="@child.Url()" class="flex items-center justify-between px-6 py-2.5 text-[13px] hover:bg-primary/5 hover:text-primary">
                                            @child.Name
                                            @if(l3Items.Any()){ <svg class="w-3 h-3 -rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7"/></svg> }
                                        </a>
                                        @if(l3Items.Any()){
                                            <ul x-show="subOpen" x-cloak class="absolute submenu-pc w-64 py-2 bg-white dark:bg-[#1a1a1c] shadow-2xl border border-gray-100 dark:border-white/10 rounded-xl">
                                                @foreach (var sub in l3Items) {
                                                    <li><a href="@sub.Url()" class="block px-6 py-2.5 text-[13px] hover:text-primary">@sub.Name</a></li>
                                                }
                                            </ul>
                                        }
                                    </li>
                                }
                            </ul>
                        }
                    </li>
                }
            </ul>
        </nav>

        <div class="flex items-center gap-1">
            <button @@click="searchOpen = !searchOpen; if(searchOpen) $nextTick(() => $refs.searchInputPC.focus())" class="hidden md:flex p-3 hover:text-primary text-gray-700 dark:text-gray-300">
                <svg x-show="!searchOpen" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <svg x-show="searchOpen" x-cloak class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
            </button>

            @if (isIntranet) {
                <a href="@loginUrl" class="hidden md:flex p-3 items-center gap-2 hover:text-primary @(isLoggedIn ? "text-primary font-bold" : "text-gray-700 dark:text-gray-300")">
                    @if(isLoggedIn) {
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <span class="hidden lg:inline text-xs font-bold uppercase">@memberName</span>
                    } else {
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                        <span class="hidden lg:inline text-xs font-bold uppercase">Login</span>
                    }
                </a>
            }

            <button @@click="mobileOpen = true" class="md:hidden p-4 text-gray-700 dark:text-white">
                <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16m-7 6h7"/></svg>
            </button>
        </div>
    </div>

    <div x-show="searchOpen" 
         x-cloak 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 -translate-y-2"
         x-transition:enter-end="opacity-100 translate-y-0"
         class="hidden md:block absolute top-[75px] left-0 w-full bg-white dark:bg-[#0d0d0e] border-b dark:border-white/10 shadow-xl z-50">
        <div class="max-w-3xl mx-auto py-6 px-4">
            <form action="@searchUrl" method="get" class="relative">
                <input x-ref="searchInputPC" type="text" name="q" placeholder="Nhập từ khóa và nhấn Enter..." 
                       class="w-full bg-gray-100 dark:bg-white/5 border-none rounded-lg px-6 py-3 text-lg outline-none focus:ring-2 focus:ring-primary dark:text-white" />
                <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-primary font-bold">TÌM KIẾM</button>
            </form>
        </div>
    </div>

    <div x-show="mobileOpen" x-cloak class="fixed inset-0 z-[200] md:hidden">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" @@click="mobileOpen = false"></div>
        <div class="fixed inset-y-0 right-0 w-[300px] bg-white dark:bg-[#0d0d0e] flex flex-col transition" x-show="mobileOpen" x-transition:enter="transform transition duration-300" x-transition:enter-start="translate-x-full">
            <div class="flex items-center justify-between p-4 border-b dark:border-white/10">
                <span class="text-[10px] font-black uppercase text-primary tracking-[0.2em]">Menu System</span>
                <button @@click="mobileOpen = false" class="p-2 text-gray-400">✕</button>
            </div>
            <div class="p-4 border-b dark:border-white/5">
                <form action="@searchUrl" method="get" class="relative">
                    <input type="text" name="q" placeholder="Search..." class="w-full bg-gray-50 dark:bg-white/5 border-none rounded-lg px-4 py-2 text-sm outline-none" />
                    <button type="submit" class="absolute right-3 top-2 text-gray-400"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button>
                </form>
            </div>
            <div class="flex-grow overflow-y-auto p-4">
                @foreach (var item in menuItems) {
                    var l2 = item.Children().Where(x => x.IsVisible(PublishedValueFallback)).ToArray();
                    <div x-data="{ subOpen: false }" class="mb-5">
                        <div class="flex items-center justify-between">
                            <a href="@item.Url()" class="font-bold text-sm @(item.IsAncestorOrSelf(Model) ? "text-primary" : "text-gray-800 dark:text-gray-200")">@item.Name</a>
                            @if(l2.Any()){ <button @@click="subOpen = !subOpen" class="p-2"><svg class="w-4 h-4 transition-transform" :class="subOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7"/></svg></button> }
                        </div>
                        <div x-show="subOpen" class="pl-4 mt-3 border-l border-gray-100 dark:border-white/5 space-y-4">
                            @foreach(var child in l2){
                                var l3 = child.Children().Where(x => x.IsVisible(PublishedValueFallback)).ToArray();
                                <div x-data="{ subSubOpen: false }">
                                    <div class="flex items-center justify-between">
                                        <a href="@child.Url()" class="text-sm text-gray-600 dark:text-gray-400">@child.Name</a>
                                        @if(l3.Any()){ <button @@click="subSubOpen = !subSubOpen" class="p-1"><svg class="w-3 h-3" :class="subSubOpen ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7"/></svg></button> }
                                    </div>
                                    <div x-show="subSubOpen" class="pl-4 mt-2 space-y-2 border-l border-primary/20">
                                        @foreach(var subC in l3){
                                            <a href="@subC.Url()" class="block text-xs text-gray-400">@subC.Name</a>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
                @if (isIntranet) {
                    <div class="mt-8 pt-6 border-t dark:border-white/10">
                        <a href="@loginUrl" class="flex items-center gap-3 px-4 py-3 bg-gray-100 dark:bg-white/5 rounded-xl">
                            @if(isLoggedIn) {
                                <svg class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <span class="text-xs font-black uppercase text-primary">@memberName</span>
                            } else {
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                                <span class="text-xs font-black uppercase">Login</span>
                            }
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</header>