@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<IPublishedContent>
@using Umbraco.Cms.Core.Models
@using Umbraco.Extensions

@{
    var settings = Umbraco.ContentAtRoot().FirstOrDefault(x => x.ContentType.Alias == "companySettings");
    if (settings == null) { return; }

    var logos = settings.Value<IEnumerable<IPublishedContent>>("clientLogo")?.ToList() ?? new List<IPublishedContent>();
    var title = settings.Value<string>("clientTitle") ?? "Khách hàng tiêu biểu";
    var isIntranet = Context.Request.Host.Value.Contains("intranet");
}

@if (logos.Any() && !isIntranet)
{
    <section class="py-16 overflow-hidden select-none">
        <div class="max-w-7xl mx-auto px-4">
            <h2 class="text-center text-2xl font-bold mb-10 dark:text-white">@title</h2>

            <div class="relative overflow-hidden group">
                @* Gradients làm mờ 2 đầu để hiệu ứng cuộn chuyên nghiệp *@
                <div class="pointer-events-none absolute inset-y-0 left-0 w-24 bg-gradient-to-r from-white dark:from-gray-900 to-transparent z-10"></div>
                <div class="pointer-events-none absolute inset-y-0 right-0 w-24 bg-gradient-to-l from-white dark:from-gray-900 to-transparent z-10"></div>

                @* Logo Track *@
                <div id="clientLogoTrack" 
                     class="flex overflow-x-auto scrollbar-hide cursor-grab active:cursor-grabbing"
                     style="scroll-behavior: auto; -webkit-overflow-scrolling: touch;">
                    
                    @* Render 3 lần để kéo tay không bị hụt *@
                    @for (int i = 0; i < 3; i++)
                    {
                        <div class="flex items-center flex-nowrap shrink-0" style="padding-right: 3rem;">
                            @foreach (var logo in logos)
                            {
                                <div class="flex-shrink-0 flex justify-center items-center" 
                                     style="width: 160px; margin-right: 3rem;"> @* Cố định chiều rộng và khoảng cách *@
                                    <img src="@logo.Url()" 
                                        alt="@logo.Name" 
                                        class="h-12 md:h-16 w-auto object-contain 
                                                @* Mobile: Hiện rõ | Desktop: Xám mờ, hover mới hiện màu *@
                                                grayscale-0 opacity-100 
                                                md:grayscale md:opacity-60 md:hover:grayscale-0 md:hover:opacity-100 
                                                transition-all duration-300 pointer-events-none dark:brightness-125" />
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </section>

    <style>
        /* Ẩn thanh cuộn trên mọi trình duyệt */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const track = document.getElementById('clientLogoTrack');
            let isDown = false;
            let startX, scrollLeft;
            let animationId;
            let speed = 0.7; // Tốc độ chạy tự động (pixel/frame)

            const step = () => {
                if (!isDown) {
                    track.scrollLeft += speed;
                    // Reset về giữa khi cuộn qua 2/3 tổng chiều rộng
                    if (track.scrollLeft >= (track.scrollWidth / 3) * 2) {
                        track.scrollLeft = track.scrollWidth / 3;
                    }
                }
                animationId = requestAnimationFrame(step);
            };

            // Sự kiện chuột cho Desktop
            track.addEventListener('mousedown', (e) => {
                isDown = true;
                track.classList.add('grabbing');
                startX = e.pageX - track.offsetLeft;
                scrollLeft = track.scrollLeft;
                cancelAnimationFrame(animationId);
            });

            const stopDragging = () => {
                isDown = false;
                track.classList.remove('grabbing');
                requestAnimationFrame(step);
            };

            track.addEventListener('mouseleave', stopDragging);
            track.addEventListener('mouseup', stopDragging);

            track.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - track.offsetLeft;
                const walk = (x - startX) * 2; 
                track.scrollLeft = scrollLeft - walk;
            });

            // Sự kiện cảm ứng cho Mobile
            track.addEventListener('touchstart', () => { 
                isDown = true; 
                cancelAnimationFrame(animationId); 
            }, {passive: true});
            
            track.addEventListener('touchend', () => { 
                isDown = false; 
                requestAnimationFrame(step); 
            }, {passive: true});

            // Khởi tạo vị trí ban đầu ở giữa để kéo được cả 2 bên
            setTimeout(() => {
                track.scrollLeft = track.scrollWidth / 3;
                requestAnimationFrame(step);
            }, 100);
        });
    </script>
}
