@inherits UmbracoViewPage<IPublishedContent>
@using Umbraco.Cms.Core.Models.PublishedContent
@using System.Linq

@{
    Layout = "layout.cshtml";
    var query = Context.Request.Query.ContainsKey("q")
        ? Context.Request.Query["q"].ToString().ToLowerInvariant()
        : "";
    var pageSize = Model.Value<int?>("numberOfItemsPerPage") ?? 10;
    var searchResultsPlaceHolder = Model.Value<string>("searchResultsPlaceHolder") ?? "";
    var title = Model.Value<string>("title") ?? "Search";
    var noResultsMessage = Model.Value<string>("noResultsMessage") ?? "Không tìm thấy";    
    var results = Model.Root()?
        .Descendants()
        .Where(x => !x.Value<bool>("hideFromSearch") && !string.IsNullOrEmpty(query) &&
                    (x.Name?.ToLowerInvariant().Contains(query) == true ||
                     x.Value<string>("SEOmetaDescription")?.ToLowerInvariant().Contains(query) == true))
        ?? Enumerable.Empty<IPublishedContent>();
    // Xử lý phân trang
    var pageRaw = Context.Request.Query["page"].ToString();
    var page = int.TryParse(pageRaw, out var p) && p > 0 ? Math.Min(p, (int)Math.Ceiling((double)results.Count() / pageSize)) : 1;

    var total = results.Count();
    var totalPages = (int)Math.Ceiling((double)total / pageSize);
    var paged = results.Skip((page - 1) * pageSize).Take(pageSize);
}
@await Html.PartialAsync("Partials/Shared/banner", Model)
<div class="container mx-auto py-8 px-6 md:px-12 lg:px-24">
    <form method="get" class="mb-4">
        <div class="flex items-center gap-4">
            <input type="text" name="q" value="@query" placeholder="@searchResultsPlaceHolder"
                class="flex-grow border px-3 py-2 rounded border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" />
            <button type="submit"
                    class="inline-block bg-primary text-white px-6 py-2 rounded hover:bg-secondary transition">
                @title
            </button>
        </div>
    </form>
    @if (!string.IsNullOrWhiteSpace(query))
    {
        <p class="mb-2 text-gray-800 dark:text-gray-200">Tìm thấy <strong>@total</strong> kết quả cho từ khóa: <strong>@query</strong></p>

        <div class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3">
            @foreach (var item in paged)
            {
                var url = item?.Url() ?? "#";
                var name = item?.Name ?? "Không có tiêu đề";
                var description = item?.Value<string>("Description") ?? "";
                var imageUrl = "";
                var images = item.Value<IEnumerable<IPublishedContent>>("yourMediaPickerAlias"); // Thay thế bằng alias của bạn
                if (images != null && images.Any())
                {
                    imageUrl = images.First().Url();
                }                
                <a href="@url" class="block bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden transition-transform duration-300 hover:scale-105 group">
                    <div class="flex items-star">
                        @if (!string.IsNullOrEmpty(imageUrl))
                        {
                            <div class="flex-shrink-0 w-24 h-24 px-2 overflow-hidden flex justify-center items-center">
                                <img class="w-full h-auto object-cover transition-transform duration-500 group-hover:scale-110" 
                                    src="@imageUrl" 
                                    alt="@name">
                            </div>
                        }
                        else
                        {
                            <div class="flex-shrink-0 w-20 h-20 flex items-center justify-center bg-gray dark:bg-gray-800">
                                <svg class="w-16 h-16 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                        }
                        <div class="p-4 flex flex-col justify-between flex-grow">
                            <h3 class="font-bold clamp-3-lines">
                                @name
                            </h3>
                            <p class="mt-2 text-sm clamp-3-lines text-gray-600 dark:text-gray-400">
                                @description
                            </p>
                        </div>
                    </div>
                </a>
           
            }
        </div>

        @* ✅ Phân trang sau danh sách *@
        @if (totalPages > 1)
        {
            <nav class="flex flex-wrap items-center justify-center gap-2 mt-6" aria-label="Pagination">
                @if (page > 1)
                {
                    <a href="?q=@query&page=@(page - 1)"
                    class="flex items-center gap-1 px-3 py-1 rounded text-sm transition-colors
                            bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 hover:bg-primary hover:text-white"
                    aria-label="Previous page">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </a>
                }

                <a href="?q=@query&page=1"
                class="px-3 py-1 rounded text-sm transition-colors
                        @(page == 1 ? "bg-primary text-white" : "bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 hover:bg-primary hover:text-white")"
                aria-label="Page 1">
                    1
                </a>

                @if (page > 4)
                {
                    <span class="px-2 text-gray-500 dark:text-gray-400">…</span>
                }

                @for (int i = Math.Max(2, page - 1); i <= Math.Min(totalPages - 1, page + 1); i++)
                {
                    <a href="?q=@query&page=@i"
                    class="px-3 py-1 rounded text-sm transition-colors
                            @(i == page ? "bg-primary text-white" : "bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 hover:bg-primary hover:text-white")"
                    aria-label="Page @i">
                        @i
                    </a>
                }

                @if (page < totalPages - 3)
                {
                    <span class="px-2 text-gray-500 dark:text-gray-400">…</span>
                }

                <a href="?q=@query&page=@totalPages"
                class="px-3 py-1 rounded text-sm transition-colors
                        @(page == totalPages ? "bg-primary text-white" : "bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 hover:bg-primary hover:text-white")"
                aria-label="Page @totalPages">
                    @totalPages
                </a>

                @if (page < totalPages)
                {
                    <a href="?q=@query&page=@(page + 1)"
                    class="flex items-center gap-1 px-3 py-1 rounded text-sm transition-colors
                            bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 hover:bg-primary hover:text-white"
                    aria-label="Next page">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                }
            </nav>
        }
    }
    else
    {
        <p class="text-gray-500">@searchResultsPlaceHolder</p>
    }
</div>