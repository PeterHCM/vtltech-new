@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@inject Microsoft.AspNetCore.Mvc.ViewEngines.ICompositeViewEngine viewEngine

@{
    Layout = "layout.cshtml";

    var blocks = Model.Value<Umbraco.Cms.Core.Models.Blocks.BlockGridModel>("pageContent");
    var fallbackPartial = "Partials/blockgrid/Default";
}

@if (blocks != null)
{
    @* 1. Render Hero Block riêng biệt (Thường là Full-width) *@
    var heroBlock = blocks.FirstOrDefault(b => b.Content.ContentType.Alias == "heroCarousel");
    if (heroBlock != null)
    {
        var heroPartial = $"Partials/blockgrid/{heroBlock.Content.ContentType.Alias}";
        @await Html.PartialAsync(heroPartial, heroBlock)
    }

    @* 2. Render các Content Blocks còn lại *@
    var contentBlocks = blocks.Where(b => b.Content.ContentType.Alias != "heroCarousel");
    if (contentBlocks.Any())
    {
        <div class="vtl-container">
            @* Lưu ý: Không nên ép grid-cols-12 ở đây nếu các Block bên trong đã có Grid riêng.
               Tôi để nó là một flex container hoặc stack đơn giản để đảm bảo tính thẩm mỹ của VTL.
            *@
            <div class="flex flex-col gap-16 md:gap-24">
                @foreach (var block in contentBlocks)
                {
                    var alias = block.Content.ContentType.Alias;
                    var partialPath = $"Partials/blockgrid/{alias}";
                    
                    // Kiểm tra sự tồn tại của Partial View
                    var viewResult = viewEngine.FindView(ViewContext, partialPath, isMainPage: false);
                    var partialToRender = viewResult.Success ? partialPath : fallbackPartial;

                    @await Html.PartialAsync(partialToRender, block)
                }
            </div>
        </div>
    }
}

@* 3. Section bổ trợ cuối trang *@
<section class="py-8">
    @await Html.PartialAsync("Partials/Shared/HappyClient", Model)
</section>